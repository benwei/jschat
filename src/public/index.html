<!DOCTYPE html>
<html>
  <head>
    <style>
body {
  font-family: Tahoma, Geneva, sans-serif;
  background-color: #fefefe;
}

div {
  display:block;
}

.title-bar {
  width: 338px; 
  margin:0 auto;
  position: relative;
}
#chat {
  width: 338px; 
  margin:0 auto;
  position: relative;
} 

.chat-cont {
  background-color: #eeeeee;
  height: 20px;
  width: 338px; 
  padding: 5px; 
  margin-bottom: 5px;
  border-bottom: 1px solid silver;
  border-left: 1px solid silver;
  border-right: 1px solid silver; 
  border-radius:3px;
  position: relative;
}

#panel {
  width: 348px; 
  padding: 5px; 
  margin:0 auto;
  margin-bottom: 20px;
  position: relative;
}

.panel-inner
{
  background-color: #eeeeee;
  border-top: 1px solid #dddddd;
  border-bottom: 1px solid silver;
  border-left: 1px solid silver;
  border-right: 1px solid silver; 
  margin-left:3px;
  padding-top:3px;
  padding-left:3px;
}

.panel-action {
  width: 136px;
  margin-left:auto;
  margin-right:0;
  position: relative;
}

#username {
  margin-right:3px;
  width:250px;
}
#tabox {
  width:319px;
  height:100px;
}

    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/json.js"></script>
    <script>
        var msg_pool = new Array();

      function updateStats(blob) {
	      var msg = '<div class="chat-cont">' + blob.sender + ":" + blob.data + "</div>";
          msg_pool.push(msg);
          var chats = msg_pool.join("");
          var height = $('body').height();
          $('body').scrollTop(height);
          $('#chat').html(chats);
      }

      var timer_reconnect = null;
      var retry_interval = 5;
      var verbose = 0;
      var ws;
      function start_wsserver() {
	      var host = window.document.location.host.replace(/^http:\/\//, '');
	      ws = new WebSocket('ws://' + host);
	      ws.onmessage = function (event) {
		      if (timer_reconnect) {
			      clearInterval(timer_reconnect);
			      timer_reconnect = null;
			      updateStats({sender: 'Client', data:"Server connected."}); 
		      }

		      var obj;
		      try {
			      obj = JSON.parse(event.data);
		      } catch (e) {};
		      if (obj)
		      updateStats(obj);
	      };
	      ws.onerror = function (err) {
		      console.log("ws error:" + JSON.stringify(err)); 
              ws.close();
	      };
	      ws.onclose = function () {
		      if (!timer_reconnect) {
                  verbose = 1;
			      timer_reconnect = setInterval(function () {
                    if (verbose) {
                        verbose = 0;
                        updateStats({sender: 'Client', data:"Server has been shutdown, reconnecting..."}); 
                    }
				      start_wsserver();
			      }, retry_interval * 1000);
		      }
	      };
      }


    $(document).ready(function()
    {
    var tabox = $('#tabox');
    var msgbar=$('#msg');
    var user = "guest";
    $('#sendmsg').click(
        function () {
           var boxtext = tabox.val()
           .replace(/>/g,'&gt;')
           .replace(/</g, '&lt;')
           .replace(/\r\n|\r|\n/g, "<br/>");
           if (boxtext.length == 0) {
                msgbar.html("cannot be empty");
                return;
           }
           
           var blob = {sender: user, data:boxtext};
           ws.send(JSON.stringify(blob)); 
           });

     $('#btnclear').click(function (){
           tabox.val('');
         });
     $('#btnregister').click(function (){
           user = $('#username').val()
           .replace(/>/g,'&gt;')
           .replace(/</g, '&lt;');
           if (user.length == 0) {
                msgbar.html("missing username");
                     $('#username').focus()
                return;
           }

           var blob = {sender: user, cmd:'register'};
           ws.send(JSON.stringify(blob)); 
           });

    updateStats({sender: 'System', data: "Welcome to jschat"});
    start_wsserver();
    });
</script>
</head>
<body>
<div class="title-bar">
<strong>Lan Chat Server</strong><br/>
</div>
<div id='panel'>
<div class='panel-inner'>
<input type="textbox" id="username" value="" length=25><input type=button id="btnregister" value="Register"><br/>
<textarea id='tabox' cols=80 rows="25"></textarea></textarea>
<div class='panel-action'>
<input type=button id="sendmsg" value="Send">
<input type=button id="btnclear" value="Clear">
</div>
<div id=msg>...</div>
</div>
</div>
<div id='chat'></div>
</body>
</html>
