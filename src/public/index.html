<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Tahoma, Geneva, sans-serif;
      }

      div {
        display: inline;
      }
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/json.js"></script>
    <script>
        var msg_pool = new Array();

      function updateStats(blob) {
	      var msg = blob.sender + ":" + blob.data + "<br>";
          msg_pool.push(msg);
          var chats = msg_pool.join("");
          var height = $('body').height();
          $('body').scrollTop(height);
          $('#chat').html(chats);
      }

      var timer_reconnect = null;
      var retry_interval = 5;
      var verbose = 0;
      var ws;
      function start_wsserver() {
	      var host = window.document.location.host.replace(/^http:\/\//, '');
	      ws = new WebSocket('ws://' + host);
	      ws.onmessage = function (event) {
		      if (timer_reconnect) {
			      clearInterval(timer_reconnect);
			      timer_reconnect = null;
			      updateStats({sender: 'Client', data:"Server connected."}); 
		      }

		      var obj;
		      try {
			      obj = JSON.parse(event.data);
		      } catch (e) {};
		      if (obj)
		      updateStats(obj);
	      };
	      ws.onerror = function (err) {
		      console.log("ws error:" + JSON.stringify(err)); 
              ws.close();
	      };
	      ws.onclose = function () {
		      if (!timer_reconnect) {
                  verbose = 1;
			      timer_reconnect = setInterval(function () {
                    if (verbose) {
                        verbose = 0;
                        updateStats({sender: 'Client', data:"Server has been shutdown, reconnecting..."}); 
                    }
				      start_wsserver();
			      }, retry_interval * 1000);
		      }
	      };
      }


    $(document).ready(function()
    {
    var tabox = $('#tabox');
    var msgbar=$('#msg');
    $('#sendmsg').click(
        function () {
           var boxtext = tabox.val()
           .replace(/>/g,'&gt;')
           .replace(/</g, '&lt;')
           .replace(/\r\n|\r|\n/g, "<br/>");
           if (boxtext.length == 0) {
                msgbar.html("cannot be empty");
                return;
           }
           
           var user = $('#username').val()
           .replace(/>/g,'&gt;')
           .replace(/</g, '&lt;');
           if (user.length == 0) {
                msgbar.html("missing username");
                     $('#username').focus()
                return;
           }

           var blob = {sender: user, data:boxtext};
           ws.send(JSON.stringify(blob)); 
           });

     $('#btnclear').click(function (){
           tabox.val('');
         });

    updateStats({sender: 'System', data: "Welcome to jschat"});
    start_wsserver();
    });
</script>
</head>
<body>
<strong>Lan Chat Server</strong><br/>
<div id='panel'>
<input type="textbox" id="username" value="" length=25 style="width:200px;"><br/>
<textarea id='tabox' cols=80 rows="25" style="width:200px; height:100px;"></textarea></textarea>
<input type=button id="sendmsg" value="Send">
<input type=button id="btnclear" value="Clear"><br/>
<div id=msg>...</div>
</div><br/>
<div id='chat'></div><br/>
</body>
</html>
