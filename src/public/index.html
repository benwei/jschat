<!DOCTYPE html>
<html>
<head>
<title>Wow Chat</title>
<link rel="stylesheet" type="text/css" href="css/app.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/json.js"></script>
<script>

function pad(n) {
   return n < 10 ? '0' : ''; 
}

function dateToString(y, m, d, H, M, S) {
    return y + "-" + pad(m) + m + "-" + pad(d) + d + " "
           + pad(H) + H + ":" + pad(M) + M + ":" + pad(S) + S;
}

function dateTo8601String(y, m, d, H, M, S) {
    return y + "-" + pad(m) + m + "-" + pad(d) + d + "T"
           + pad(H) + H + ":" + pad(M) + M + ":" + pad(S) + S + "Z";
}

function TStoLocaltime(ts)
{
    var dtts = new Date(ts);

    var utcstr = dateTo8601String(dtts.getUTCFullYear(), dtts.getUTCMonth(), dtts.getUTCDate(),
           dtts.getUTCHours(), dtts.getUTCMinutes(), dtts.getUTCSeconds());
    var dt = new Date(utcstr);
    return dateToString(dt.getFullYear(), dt.getMonth(), dt.getDate(),
           dt.getHours(), dt.getMinutes(), dt.getSeconds());
}

function post_hide(item) {
    var target= '#post_' + item.attr('id').split('_')[1];
    console.log("hide" + target);
    $(target).hide();
}

var  post_num = 0;
function updateStats(blob) {
    post_num++;

    var msg = '<div id="post_' + post_num + '" class="chat-cont"><div id="rm_' + post_num + '" class="post-hide">x</div>';
    msg += '<div class="sender">' + blob.sender + "</div>"
    msg += '<div class="data">' + blob.data + '</div>';
    if (blob.ts) {
        msg += '<div class="timestamp">' + TStoLocaltime(blob.ts) + '</div>';
    }
    msg + "</div>";
    var height = $('body').height();
    $('body').scrollTop(height);
    $('#chat').append(msg);


    $('#rm_' + post_num).click(function(){
      post_hide($(this));
    });
    $('#post_' + post_num).mouseout(function (){
            var num = $(this).attr('id').split('_')[1];
            $("#rm_" + num).hide();
            });
    $('#post_' + post_num).mouseover(function (){
            var num = $(this).attr('id').split('_')[1];
            $("#rm_" + num).show();
            });
}

var timer_reconnect = null;
var retry_interval = 5;
var verbose = 0;
var ws;
function start_wsserver() {
    var host = window.document.location.host.replace(/^http:\/\//, '');
    ws = new WebSocket('ws://' + host);
    ws.onmessage = function (event) {
        if (timer_reconnect) {
            clearInterval(timer_reconnect);
            timer_reconnect = null;
            updateStats({sender: 'Client', data:"Server connected."}); 
        }

        var obj;
        try {
            obj = JSON.parse(event.data);
        } catch (e) {};
        if (obj)
            updateStats(obj);
    };
    ws.onerror = function (err) {
        console.log("ws error:" + JSON.stringify(err)); 
        ws.close();
    };
    ws.onclose = function () {
        if (!timer_reconnect) {
            verbose = 1;
            timer_reconnect = setInterval(function () {
                    if (verbose) {
                    verbose = 0;
                    updateStats({sender: 'Client', data:"Server has been shutdown, reconnecting..."}); 
                    }
                    start_wsserver();
                    }, retry_interval * 1000);
        }
    };
}

function floatMsgShow(float_msg) {
    var msgbar=$('#float-msg');
    msgbar.html(float_msg);
    try {
    msgbar.show();
    } catch (e) {}

    setTimeout(function (){
    msgbar.hide().fadeOut(2000); }, 1000);
}


$(document).ready(function()
        {
        var tabox = $('#tabox');
        var user = "guest";
        var onsending = false;
        $('#sendmsg').click(
            function () {
            if (onsending)  {
                return ;
            }
            onsending = true;
            var boxtext = tabox.val()
            .replace(/>/g,'&gt;')
            .replace(/</g, '&lt;')
            .replace(/\r\n|\r|\n/g, "<br/>");
            if (boxtext.length == 0) {
                floatMsgShow("chat message cannot be empty.");
                onsending = false;
                return;
            }

            var blob = {sender: user, data:boxtext};
            ws.send(JSON.stringify(blob)); 

            onsending = false;
            });

        $('#btnclear').click(function (){
                tabox.val('');
                });
        $('#btnregister').click(function (){
                user = $('#login-name').val()
                .replace(/>/g,'&gt;')
                .replace(/</g, '&lt;');
                if (user.length == 0) {
                floatMsgShow("missing login name");
                $('#login-name').focus()
                return;
                }

                var blob = {sender: user, cmd:'register'};
                ws.send(JSON.stringify(blob)); 
                });

        updateStats({sender: 'System', data: "Welcome to jschat"});
        start_wsserver();
        });
</script>
</head>
<body>
<div style="position: absolute; left: 50%;"><div id='float-msg'></div>
</div>
<div class="title-bar">Lan Chat</div>
<div id='panel'>
<div class='panel-inner'>
<input type="textbox" id="login-name" value="" length=25><input type=button id="btnregister" value="Register"><br/>
<textarea id='tabox' cols=80 rows="25"></textarea></textarea>
<div class='panel-action'>
<input type=button id="sendmsg" value="Send">
<input type=button id="btnclear" value="Clear">
</div>
</div>
</div>
<div id='chat'></div>
</body>
</html>
